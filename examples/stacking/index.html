<!DOCTYPE html>
<meta charset="utf-8">
<style>

.subject {
  fill: red;
  fill-opacity: 0.3;
  stroke-width: 1px;
  stroke: #727272;
}

.figure {
  fill: none;
  stroke-width: 1px;
  stroke: #727272;
}

.square {
  fill: none;
  stroke-width: 2px;
  stroke: blue;
}

</style>
<body>
<script src="https://d3js.org/d3-polygon.v0.2.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="../../build/partials.js"></script>
<script>

var svg,
    width = 960,
    height = 500,
    color,
    N = 10, vertices,
    triangles,
    source, stacked,
    area,
    square, arranged = [];

color = d3.scale.category10();

vertices = d3.range(N).map(function(d) {
  return [Math.random() * width / 3, Math.random() * height / 3];
});

svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

source = d3.geom.delaunay(vertices).map(function(d) { return d; });

area = d3.sum(source, function(d) { return d3_polygon.polygonArea(d); });

square = partials.stack(source.map(stackable));

square.forEach(function(rectangles) {
  [].push.apply(arranged, rectangles);
});

svg.selectAll(".figure")
    .data(source.map(function(d) { return "M" + d.join("L") + "Z"; }), String)
  .enter().append("path")
    .attr("class", "figure")
    .attr("d", String);

svg.selectAll(".source")
    .data(arranged.map(function(d) { return "M" + d.join("L") + "Z"; }), String)
  .enter().append("path")
    .attr("class", "subject")
    .attr("d", String);

svg.selectAll(".square")
    .data([square.square].map(function(d) { return "M" + d.join("L") + "Z"; }), String)
  .enter().append("path")
    .attr("class", "square")
    .attr("d", String);

function stackable(triangle) {
  return partials.rectangle2Rectangle(partials.triangle2Rectangle(triangle), Math.sqrt(area));
}

</script>