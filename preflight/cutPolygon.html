<!DOCTYPE html>
<meta charset="utf-8">
<style>

path {
  stroke-linecap: butt;
}

.figure {
  stroke-width: 2px;
  stroke: #000;
  fill: none;
}

.cut {
  stroke-width: 2px;
  stroke-dasharray: 5, 5;
  stroke: #000;
}

.vertex {
  cursor: none;
  pointer-events: none;
  fill: #000;
}

.debug {
  stroke-width: 2px;
  fill-opacity: 0.7;
  stroke: #000;
}

.handle {
  cursor: move;
  pointer-events: all;
  stroke-width: 2px;
  fill-opacity: 0.5;
  stroke: #000;
  fill: #ff9933;
}

.handle:hover {
  fill-opacity: 1;
}

</style>
<svg width="960" height="500">
</svg>
<script src="../node_modules/d3-polygon/build/d3-polygon.js"></script>
<script src="../build/partials.js"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script>

var a = [40, 150], b = [100, 400], c = [500, 400], d = [400, 100], e = [50, 50],
    segment = [e, [750, 400]],
    A0, A1, data, polygons;

var data = [a, b, c, d, e];
var polygons = partials.cutPolygon(segment[0], segment[1], data);

var drag = d3.behavior.drag()
    .origin(function(d) { return {x: d[0], y: d[1]}; })
    .on("dragstart", dragstarted)
    .on("drag", dragged);

var color = d3.scale.category10();

var svg = d3.select("svg").append("g");

var line = d3.svg.line()
              .x(function(d) { return d[0]; })
              .y(function(d) { return d[1]; })
              .interpolate("linear-closed");

update();

function update() {
  d3.selectAll(".cut").remove();
  d3.selectAll(".figure").remove();
  d3.selectAll(".vertex").remove();
  d3.selectAll(".debug").remove();
  d3.selectAll(".handle").remove();

  polygons = partials.cutPolygon(segment[0], segment[1], data);

  var cut = svg.append("path")
                .attr("class", "cut")
                .datum(segment)
                .attr("d", d3.svg.line());

  var figure = svg.append("path")
                  .attr("class", "figure")
                  .datum(data)
                  .attr("d", line);

  var debug = svg.selectAll(".debug")
                    .data(polygons);

  debug.enter().append("path")
                    .style("fill", function(d, i) { return color(i); })
                    .attr("class", "debug")
                    .attr("d", line);

  var vertex = svg.selectAll(".vertex")
                .data([].concat.apply([], polygons));

  vertex.enter()
      .append("circle")
      .attr("class", "vertex")
      .attr("r", 5)
      .attr("cx", function(d) { return d[0]; })
      .attr("cy", function(d) { return d[1]; });


  var handle = svg.selectAll(".handle")
                .data(data);      
  handle.enter()
      .append("circle")
      .attr("class", "handle")
      .attr("r", 10)
      .attr("cx", function(d) { return d[0]; })
      .attr("cy", function(d) { return d[1]; });

  handle.call(drag);
    
  vertex.data([].concat.apply([], polygons));
  
  vertex
      .attr("cx", function(d) { return d[0]; })
      .attr("cy", function(d) { return d[1]; });
}

function dragstarted(d) {
  this.parentNode.appendChild(this);
}

function dragged(d) {
  d[0] = d3.event.x;
  d[1] = d3.event.y;
  update();
}

</script>